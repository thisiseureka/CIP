import{a3 as u,a4 as p}from"./_applist-952.js";import{dx as r,_ as a}from"./main-red-poems-invite.js";import{s as m}from"./machine.-578.js";import"./lodash-840.js";import"./mutative-12.js";globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(n,t){return this.cache.has(n)?this.cache.get(n):(this.cache.set(n,t),t)}};const h=async n=>r({headers:{"X-Auth-Token":["api-key ",{encryption:"hmac_decrypt",value:n}]},method:"GET",url:"https://api.getresponse.com/v3/campaigns"}),C=async n=>r({headers:{"X-Auth-Token":["api-key ",{encryption:"hmac_decrypt",value:n}]},method:"GET",queryParams:{perPage:1e3},url:"https://api.getresponse.com/v3/custom-fields"}),g=async n=>r({headers:{"X-Auth-Token":["api-key ",{encryption:"hmac_decrypt",value:n}]},method:"GET",url:"https://api.getresponse.com/v3/tags"});globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(n,t){return this.cache.has(n)?this.cache.get(n):(this.cache.set(n,t),t)}};const E=n=>{const t=[{label:a("Email"),value:"email"},{label:a("Name"),value:"name"}];return"httpStatus"in n&&n.httpStatus!==200||!Array.isArray(n)||n==null||n.forEach(o=>{t.push({label:o.name,value:o.customFieldId})}),t},s=async n=>{n.setComponent("field-map",e=>{e.loading=!0,n.util.isRepeaterFieldComponent(e)&&(e.labelActionLoading=!0)});const t=await n.getConnection();if(!t){n.setComponent("field-map",e=>{e.loading=!1,n.util.isRepeaterFieldComponent(e)&&(e.labelActionLoading=!1)});return}const{data:o}=await C(t.auth_details.value);n.setComponent("field-map",e=>{if(!n.util.isRepeaterFieldComponent(e))return;const i=e.fieldsMetaData[0];i.options=E(o),n.util.isRepeaterFieldComponent(e)&&(e.labelActionLoading=!1),e.loading=!1})},l=async n=>{n.setComponent("list-id",e=>{e.loading=!0});const t=await n.getConnection();if(!t){n.setComponent("list-id",e=>{e.loading=!1});return}const{data:o}=await h(t.auth_details.value);if("httpStatus"in o&&o.httpStatus!==200||!Array.isArray(o)){n.setComponent("list-id",e=>{n.util.isSelectComponent(e)&&(e.loading=!1,e.status="error",e.invalidMessage=a("Failed to fetch lists"))});return}n.setComponent("list-id",e=>{n.util.isSelectComponent(e)&&(e.options=(o==null?void 0:o.map(i=>({label:i.name,value:i.campaignId})))||[],e.loading=!1,e.status=void 0)})},c=async n=>{n.setComponent("tags",e=>{e.loading=!0});const t=await n.getConnection();if(!t){n.setComponent("tags",e=>{e.loading=!1});return}const{data:o}=await g(t.auth_details.value);if(!Array.isArray(o)){n.setComponent("tags",e=>{n.util.isSelectComponent(e)&&(e.loading=!1,e.status="error",e.invalidMessage=a("No tags found or failed to fetch tags"))});return}n.setComponent("tags",e=>{n.util.isSelectComponent(e)&&(e.options=(o==null?void 0:o.map(i=>({label:i.name,value:i.tagId})))||[],e.loading=!1,e.status=void 0)})},T=(n,t)=>{const o=n.getComponent("list-id");!t.isSelectComponent(o)||!o.value||!o.options||o.options.some(e=>e.value===o.value)||(n.setComponent("list-id",e=>{e.value=void 0}),n.setDb(e=>{e.listId=void 0}))};globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(n,t){return this.cache.has(n)?this.cache.get(n):(this.cache.set(n,t),t)}};const A=u(({helpers:n})=>({states:{components:[{addConnectionHelpingText:a("You can get your API key from")+' <a class="text-blue-600 underline" href="https://app.getresponse.com/api" target="_blank" rel="noopener noreferrer nofollow">'+a("here")+"</a>",componentName:n.componentName.connection,connectionsTypes:[{encryptKeys:["value"],label:a("API Key"),showKey:!1,type:"api_key",verifyConnection:{headers:{"X-Auth-Token":""},method:"GET",responseKeyMatch:["accountId","email"],url:"https://api.getresponse.com/v3/accounts"}}],fieldType:"config",id:"connection-id",label:a("Select Connection"),onConnectionAddChange:"CONNECTION_ADD_CHANGE",onConnectionChange:"SET_CONNECTION",render:!0,value:void 0},{componentName:n.componentName.select,fieldType:"config",id:"list-id",label:a("List"),onChange:"HANDLE_LIST_ID",onRefetch:"REFETCH_LISTS",options:[],path:"listId",placeholder:a("Select a list"),render:"IF_CONNECTION_SELECTED",value:void 0},{addItemButtonLabel:a("Add Item"),componentName:n.componentName.repeaterField,fieldsMetaData:[{componentName:n.componentName.select,label:a("Field"),name:"getResponseField",optionFilterProp:"label",options:[],required:!0,showSearch:!0,value:void 0,wrapperClassName:"w-100"},{componentName:n.componentName.mixInput,label:a("Value"),name:"value",required:!0,value:[],wrapperClassName:"w-100"}],id:"field-map",label:a("Field Map"),labelActionIconName:"refresh-cw",labelActionOnClick:"REFETCH_FIELDS",labelActionText:a("Refetch Fields"),loading:!1,nonRemovableRows:[0],onChange:"ON_CHANGE_FIELD_MAP",render:"IF_LIST_SELECTED",value:[[{disabled:!0,name:"getResponseField",value:"email"},{name:"value",value:[]}]],wrapperClassName:"mt-3"},{componentName:n.componentName.select,id:"tags",label:a("Tags"),mode:"multiple",onChange:"HANDLE_TAGS",onRefetch:"REFETCH_TAGS",options:[],path:"tags",placeholder:a("Select Tags to attach with the contact."),render:"IF_LIST_SELECTED",value:void 0},{componentName:n.componentName.input,id:"autoresponder-day",label:a("Autoresponder Day"),min:0,onChange:"HANDLE_INPUT",path:"autoresponderDay",placeholder:a("Input number of day(s) for autoresponder cycle."),render:"IF_LIST_SELECTED",type:"number",value:void 0},{componentName:n.componentName.select,helperText:a("Override the existing contact info by responses."),id:"override-existing",label:a("Override Existing"),onChange:"HANDLE_OVERRIDE_EXISTING",options:[{label:a("Yes"),value:"yes"},{label:a("No"),value:"no"}],path:"overrideExisting",render:"IF_LIST_SELECTED",value:"no"}]},actions:{ON_MACHINE_LOAD:async({$:t})=>{m(t,[{db:"connectionId",id:"connection-id"},{db:"listId",id:"list-id"},{db:"fieldMap",id:"field-map"},{db:"tags",id:"tags"},{db:"autoresponderDay",id:"autoresponder-day"},{db:"overrideExisting",id:"override-existing"}]),await Promise.all([l(t),s(t),c(t)])},CONNECTION_ADD_CHANGE:({$:t,e:o})=>{t.setThisComponent(e=>{t.util.isConnectionComponent(e)&&e.connectionsTypes.forEach(i=>{var d;i.type==="api_key"&&((d=i.verifyConnection)!=null&&d.headers)&&(i.verifyConnection.headers["X-Auth-Token"]="api-key "+o.value)})})},HANDLE_LIST_ID:async({$:t,e:o})=>{t.setThisComponent(e=>{e.value=o}),t.setDb(e=>{e.listId=o}),Promise.all([s(t),c(t)])},HANDLE_OVERRIDE_EXISTING:({$:t,e:o})=>{t.setThisComponent(e=>{e.value=o}),t.setDb(e=>{e.overrideExisting=o})},HANDLE_TAGS:({$:t,e:o})=>{t.setThisComponent(e=>{e.value=o}),t.setDb(e=>{e.tags=o})},HANDLE_INPUT:({$:t,e:o})=>{t.setThisComponent(e=>{e.value=o.target.value}),t.setDb(e=>{e.autoresponderDay=o.target.value})},HANDLE_MIX_INPUT:({$:t,e:o})=>{t.setThisComponent(e=>{e.value=o})},IF_CONNECTION_SELECTED:({$:t})=>{var o;return p((o=t.getComponent("connection-id"))==null?void 0:o.value)},IF_LIST_SELECTED:({$:t})=>{var o;return p((o=t.getComponent("list-id"))==null?void 0:o.value)},ON_CHANGE_FIELD_MAP:({$:t,e:o})=>{t.setThisComponent(e=>{e.value=o}),t.setDb(e=>{e.fieldMap=o})},SET_CONNECTION:async({$:t,e:o})=>{t.setThisComponent(e=>{e.value=o}),t.setDb(e=>{e.connectionId=o}),await l(t),T(t,n)},REFETCH_LISTS:async({$:t})=>{await l(t)},REFETCH_FIELDS:async({$:t})=>{await s(t)},REFETCH_TAGS:async({$:t})=>{await c(t)}}}));export{A as default};
