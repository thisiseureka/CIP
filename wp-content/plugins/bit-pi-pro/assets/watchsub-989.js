import{a3 as h,a4 as C}from"./_applist-952.js";import{dx as d,_ as c}from"./main-red-poems-invite.js";import{s as p}from"./machine.-578.js";import"./lodash-840.js";import"./mutative-12.js";globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(t,e){return this.cache.has(t)?this.cache.get(t):(this.cache.set(t,e),e)}};const f=async(t,e=0)=>d({method:"GET",queryParams:{apiKey:{encryption:"hmac_decrypt",value:t},filter:JSON.stringify({status:"ENABLED"}),limit:20,offset:e},url:"https://api.jotform.com/user/forms"}),_=async(t,e,n)=>d({bodyParams:{webhookURL:n},method:"POST",queryParams:{apiKey:{encryption:"hmac_decrypt",value:t}},url:`https://api.jotform.com/form/${e}/webhooks`});globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(t,e){return this.cache.has(t)?this.cache.get(t):(this.cache.set(t,e),e)}};const y=async(t,e)=>{var i,s;const n=await t.getConnection();if(!n||!((i=n.auth_details)!=null&&i.value))return;const{data:o}=await _(n.auth_details.value,(s=t.getComponent("form-id"))==null?void 0:s.value,e);let a="We have attached the webhook to your form.";(!o.responseCode||o.responseCode>=400)&&(a=o.message),t.setComponent("note-id",r=>{t.util.isNoteComponent(r)&&(r.note=[a],r.render=!0)})},l=async(t,e=0)=>{t.setComponent("form-id",a=>{a.loading=!0});const n=await t.getConnection();if(!n)return;const o=n.auth_details.value;try{const{data:a,status:i}=await f(o,e);if(i!=="success")throw new Error("Invalid response format");if(!a.responseCode||a.responseCode>=400)throw new Error(a.message);t.setComponent("form-id",s=>{var m;if(!t.util.isSelectComponent(s))return;const r=a.content.map(u=>({label:u.title,value:u.id}));s.options=e===0?r:(m=s.options)==null?void 0:m.concat(r),s.loading=!1})}catch(a){t.setComponent("form-id",i=>{t.util.isSelectComponent(i)&&(i.loading=!1,i.status="error",a instanceof Error&&(i.invalidMessage=a.message))})}};globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(t,e){return this.cache.has(t)?this.cache.get(t):(this.cache.set(t,e),e)}};const b=h(({helpers:t})=>({states:{components:[{componentName:t.componentName.webhook,extraComponents:[{addConnectionHelpingText:c('You can get your API key from <a class="text-blue-600 underline" href="https://www.jotform.com/myaccount/api" target="_blank" rel="noopener noreferrer nofollow">here</a>'),componentName:t.componentName.connection,connectionsTypes:[{encryptKeys:["value"],label:c("API Key"),showKey:!1,type:"api_key",verifyConnection:{method:"GET",queryParams:{apiKey:""},responseKeyMatch:["message"],responseMatch:{responseCode:200},url:"https://api.jotform.com/user"}}],fieldType:"config",id:"connection-id",label:c("Select Connection"),onConnectionAddChange:"CONNECTION_ADD_CHANGE",onConnectionChange:"SET_CONNECTION",render:!0,value:void 0},{componentName:t.componentName.select,fieldType:"config",id:"form-id",isLoadable:!0,label:c("Select Form"),onChange:"HANDLE_SELECT_FORM",onLoadData:"ON_LOAD_FORM_DATA",onRefetch:"REFETCH_FORMS",optionFilterProp:"label",options:[],placeholder:c("Select a form"),render:"IF_CONNECTION_SELECTED",required:!0,showSearch:!0,value:void 0}],fieldType:"config",id:"webhook-id",label:c("Webhook"),onPopoverToggle:"ADD_WEBHOOK_POPOVER_TOGGLE",onSave:"CONNECT_WEBHOOK_WITH_JOTFORM",onValidate:"HANDLE_VALIDATION",onWebhookChange:"SET_WEBHOOK",render:!0,value:void 0},{componentName:t.componentName.note,fieldType:"config",id:"note-id",label:c("Note"),note:[],render:!1}]},actions:{ON_MACHINE_LOAD:async({$:e})=>{p(e,[{db:"webhookId",id:"webhook-id"}])},IF_CONNECTION_SELECTED:({$:e})=>{var n;return C((n=e.getComponent("connection-id"))==null?void 0:n.value)},CONNECTION_ADD_CHANGE:({$:e,e:n})=>{e.setThisComponent(o=>{e.util.isConnectionComponent(o)&&o.connectionsTypes.forEach(a=>{var i;a.type==="api_key"&&((i=a.verifyConnection)!=null&&i.queryParams)&&(a.verifyConnection.queryParams.apiKey=n.value)})})},SET_CONNECTION:async({$:e,e:n})=>{e.setThisComponent(o=>{o.value=n,e.util.isConnectionComponent(o)&&(o.status=void 0)}),e.setDb(o=>{o.connectionId=n}),await l(e)},HANDLE_SELECT_FORM:async({$:e,e:n})=>{e.setThisComponent(o=>{o.value=n,e.util.isSelectComponent(o)&&(o.status=void 0)}),e.setDb(o=>{o.formId=n})},REFETCH_FORMS:async({$:e})=>{await l(e)},ON_LOAD_FORM_DATA:async({$:e,e:n})=>{await l(e,n.count+20)},ADD_WEBHOOK_POPOVER_TOGGLE:async({$:e,e:n})=>{n&&await l(e)},SET_WEBHOOK:async({$:e,e:{id:n}})=>{e.setThisComponent(o=>{o.value=n}),e.setDb(o=>{o.webhookId=n})},HANDLE_VALIDATION:({$:e})=>{var n,o;if(!((n=e.getComponent("connection-id"))!=null&&n.value))return e.setComponent("connection-id",a=>{e.util.isConnectionComponent(a)&&(a.status="error",a.invalidMessage="Please select a connection")}),!1;if(!((o=e.getComponent("form-id"))!=null&&o.value))return e.setComponent("form-id",a=>{e.util.isSelectComponent(a)&&(a.status="error",a.invalidMessage="Please select a form")}),!1},CONNECT_WEBHOOK_WITH_JOTFORM:async({$:e,e:n})=>{await y(e,n.url),e.setComponent("form-id",o=>{e.util.isSelectComponent(o)&&(o.value=void 0)}),e.setComponent("connection-id",o=>{e.util.isConnectionComponent(o)&&(o.value=void 0)})}}}));export{b as default};
