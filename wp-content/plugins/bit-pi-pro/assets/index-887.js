import{r as l,v as ie,av as Ue,e as Ye,au as We,g as Xe,q as Be,dx as Je,a as x,j as n,_ as o,B as K,t as Oe,i as Fe,S as Re,ae as De,cQ as Ze,aY as Ge,c as $e,F as Ve,y as Le,dy as et,dz as tt,dA as at,l as _e,dc as st,cj as nt,aT as Se,aB as it,n as ct,L as ot,p as lt}from"./main-red-poems-invite.js";import{b as rt,a2 as ht,D as ae,m as ut}from"./_applist-952.js";import{S as Z}from"./index-469.js";import{c as W,a as dt}from"./mutative-12.js";import{l as Ne}from"./lodash-840.js";import{I as Q}from"./index-383.js";import{T as X,R as pt}from"./index-384.js";import{F as G}from"./index-573.js";import{$ as Ke,c as Me,g as ze}from"./oauthhel-944.js";import{I as mt}from"./index.es-493.js";import{u as Qe,M as Ct}from"./import-208.js";import{P as yt}from"./index-836.js";globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(t,a){return this.cache.has(t)?this.cache.get(t):(this.cache.set(t,a),a)}};const B=l.createContext({appName:"untitled",appSlug:"untitled",connectionsTypes:[],isConnecting:!1,onConnectionChange:()=>{},setIsConnecting:()=>{}});globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(t,a){return this.cache.has(t)?this.cache.get(t):(this.cache.set(t,a),a)}};const J=l.createContext({isPopoverOpen:!1,setIsPopoverOpen:()=>{}});globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(t,a){return this.cache.has(t)?this.cache.get(t):(this.cache.set(t,a),a)}};function se(){const{id:t}=ie(Ue),a=Ye(rt),c=We(),{isPending:e,mutateAsync:s}=Xe({mutationFn:async i=>Be("connections/save",i,void 0,"POST"),mutationKey:["save_connection"],onSuccess:i=>{i.data&&(c.setQueryData(["connections",i.data.app_slug,"all"],r=>W(r||{data:[]},h=>{h.data.push(i.data)})),a(r=>W(r,h=>{const p=h[t];p!=null&&p.states&&(p.states.connections||(p.states.connections=[]),p.states.connections.push(i.data))})))}});return{isSavingConnection:e,saveConnection:s}}globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(t,a){return this.cache.has(t)?this.cache.get(t):(this.cache.set(t,a),a)}};async function ne(t){if(!t)return!0;const{responseKeyMatch:a,responseMatch:c}=t;if(!a&&!c)return!1;const{data:e}=await Je(t);if(c){for(const[s,i]of Object.entries(c))if(Ne.get(e,s)!==i)return!1}if(a){for(const s of a)if(!Ne.has(e,s))return!1}return!0}globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(t,a){return this.cache.has(t)?this.cache.get(t):(this.cache.set(t,a),a)}};const Ee={token:"",type:"bearer_token"};function ft({children:t,connectionConfig:a,connectionName:c}){var m,P,M,_;const[e,s]=l.useState(),{saveConnection:i}=se(),{setIsPopoverOpen:r}=l.useContext(J),[h,p]=l.useState(Ee),{appSlug:C,extraData:D,isConnecting:E,onConnectionAddChange:j,onConnectionChange:f,onConnectionSaveClick:u,onValidate:v,setIsConnecting:A}=l.useContext(B),U=O=>{const{name:F,value:S}=O.target;p(z=>{const w={...z,[F]:S};return j==null||j(w),w})},I=async(O,F)=>{try{const{data:S}=await i({app_slug:C,auth_details:O,auth_type:h.type,connection_name:c,encrypt_keys:F});r(!1),p(Ee),f==null||f(S.id)}catch(S){console.error("Error in saving connection",S),s({saveConnection:{invalidMessage:"Can't save connection",status:"error"}})}};return x("form",{onSubmit:async O=>{if(O.preventDefault(),s(void 0),v&&v(h)===!1)return;u==null||u(h),A(!0),await ne(a.verifyConnection)?await I({token:h.token,...D&&{extraData:D}},a.encryptKeys):s({token:{invalidMessage:"Invalid token",status:"error"}}),A(!1)},children:[t,n(Q,{disabled:E,invalidMessage:(m=e==null?void 0:e.token)==null?void 0:m.invalidMessage,label:o("Token"),name:"token",onChange:U,required:!0,status:(P=e==null?void 0:e.token)==null?void 0:P.status,value:h.token,wrapperClassName:"mb-2"}),((M=e==null?void 0:e.saveConnection)==null?void 0:M.status)==="error"&&n(X.Paragraph,{type:"danger",children:(_=e==null?void 0:e.saveConnection)==null?void 0:_.invalidMessage}),x(G,{gap:8,justify:"end",children:[n(K,{onClick:()=>r(!1),children:o("Cancel")}),n(K,{disabled:E,htmlType:"submit",loading:E,type:"primary",children:o("Connect")})]})]})}globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(t,a){return this.cache.has(t)?this.cache.get(t):(this.cache.set(t,a),a)}};globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(t,a){return this.cache.has(t)?this.cache.get(t):(this.cache.set(t,a),a)}};function vt(){const[t,a]=l.useState(!1),c=()=>{a(!0),setTimeout(()=>{a(!1)},2500)};return{copied:t,copy:s=>{if(window.isSecureContext&&navigator.clipboard){navigator.clipboard.writeText(s),c();return}const i=document.createElement("textarea");i.value=s,document.body.append(i),i.focus(),i.select();try{document.execCommand("copy"),c()}catch(r){console.error("Unable to copy to clipboard",r)}i.remove()}}}globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(t,a){return this.cache.has(t)?this.cache.get(t):(this.cache.set(t,a),a)}};const{Compact:bt}=Re,{useToken:gt}=Oe;function He({label:t,value:a,wrapperClassName:c,...e}){const{copied:s,copy:i}=vt(),{token:r}=gt(),h=l.useId();return x("div",{className:c,children:[t&&n("label",{className:"d-ib mb-1 font-medium",css:Fe({color:r.colorText},"",""),htmlFor:h,children:t}),x(bt,{className:"w-100",children:[n(mt,{id:h,readOnly:!0,value:a,...e}),n(De,{title:s?"Copied":"Copy",children:n(K,{"data-testid":"copy-button",icon:s?n(Ze,{}):n(Ge,{}),onClick:()=>i(String(a))})})]})]})}globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(t,a){return this.cache.has(t)?this.cache.get(t):(this.cache.set(t,a),a)}};globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(t,a){return this.cache.has(t)?this.cache.get(t):(this.cache.set(t,a),a)}};const Ie={clientId:"",clientSecret:"",type:"oauth2"};function wt({children:t,connectionConfig:a,connectionName:c}){var _,O,F,S,z;const[e,s]=l.useState(),{saveConnection:i}=se(),[r,h]=$e(Ke),{setIsPopoverOpen:p}=l.useContext(J),[C,D]=l.useState(Ie),{appSlug:E,extraData:j,isConnecting:f,onConnectionAddChange:u,onConnectionChange:v,onConnectionSaveClick:A,onValidate:U,setIsConnecting:I}=l.useContext(B),V=w=>{const{name:b,value:q}=w.target;D(k=>{const d={...k,[b]:q};return u==null||u(d),d})},m=async(w,b)=>{try{const{data:q}=await i({app_slug:E,auth_details:w,auth_type:C.type,connection_name:c,encrypt_keys:b});v==null||v(q.id),D(Ie),p(!1)}catch(q){console.error("Can't save connection",q),s({saveConnection:{invalidMessage:"Can't save connection",status:"error"}})}},P=async()=>{s(void 0),!(U&&U(C)===!1)&&(A==null||A(C),I(!0),Me(a,I))},M=async()=>{try{const w=await ze(a,r);if(!w)throw new Error("Client id or secret not correct!");if(a.verifyConnection&&!await ne(ht(a.verifyConnection,w)))throw new Error("Connection verification failed!");await m({...w,...j&&{extraData:j},client_id:C.clientId,client_secret:C.clientSecret,refresh_token_url:a==null?void 0:a.refreshTokenUrl},a.encryptKeys)}catch(w){w instanceof Error&&s({oauth:{invalidMessage:w.message,status:"error"}}),console.error(w)}h({}),I(!1)};return Qe(()=>{Object.keys(r).length>0&&M()},400,[r]),x(Ve,{children:[t,n(He,{label:o("Redirect URI"),value:Le.REDIRECT_URI,wrapperClassName:"mb-2"}),n(Q,{disabled:f,label:o("Client Id"),name:"clientId",onChange:V,status:(_=e==null?void 0:e.oauth)==null?void 0:_.status,value:C.clientId,wrapperClassName:"mb-2"}),n(Q,{disabled:f,invalidMessage:(O=e==null?void 0:e.oauth)==null?void 0:O.invalidMessage,label:o("Client Secret"),name:"clientSecret",onChange:V,status:(F=e==null?void 0:e.oauth)==null?void 0:F.status,value:C.clientSecret,wrapperClassName:"mb-2"}),((S=e==null?void 0:e.saveConnection)==null?void 0:S.status)==="error"&&n(X.Paragraph,{type:"danger",children:(z=e==null?void 0:e.saveConnection)==null?void 0:z.invalidMessage}),x(G,{gap:8,justify:"end",children:[n(K,{onClick:()=>p(!1),children:o("Cancel")}),n(K,{disabled:f,loading:f,onClick:P,type:"primary",children:o("Connect")})]})]})}globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(t,a){return this.cache.has(t)?this.cache.get(t):(this.cache.set(t,a),a)}};globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(t,a){return this.cache.has(t)?this.cache.get(t):(this.cache.set(t,a),a)}};const Pe={addTo:"header",key:"",type:"api_key",value:""};function Tt({children:t,connectionConfig:a,connectionName:c,customConnection:e}){var P,M,_,O,F,S,z,w;const[s,i]=l.useState(),{saveConnection:r}=se(),{setIsPopoverOpen:h}=l.useContext(J),[p,C]=l.useState(Pe),{appSlug:D,extraData:E,isConnecting:j,onConnectionAddChange:f,onConnectionChange:u,onConnectionSaveClick:v,onValidate:A,setIsConnecting:U}=l.useContext(B),I=(b,q)=>{C(k=>{const d={...k,[b]:q};return f==null||f(d),d})},V=async(b,q)=>{try{const{data:k}=await r({app_slug:D,auth_details:b,auth_type:p.type,connection_name:c,encrypt_keys:q});h(!1),C(Pe),u==null||u(k.id)}catch(k){console.error("Error in saving connection",k),i({saveConnection:{invalidMessage:"Can't save connection",status:"error"}})}};return x("form",{onSubmit:async b=>{if(b.preventDefault(),i(void 0),A&&A(p)===!1)return;if(v==null||v(p),U(!0),await ne(a.verifyConnection)){const k={value:p.value,...E&&{extraData:E}};(e||(a==null?void 0:a.showKey)!==!1)&&(k.key=p.key),e&&(k.addTo=p.addTo),await V({...k},a.encryptKeys)}else i({value:{invalidMessage:"Invalid api key",status:"error"}});U(!1)},children:[t,(e||(a==null?void 0:a.showKey)!==!1)&&n(Q,{disabled:j,invalidMessage:(P=s==null?void 0:s.key)==null?void 0:P.invalidMessage,label:o("Name"),onChange:b=>I("key",b.target.value),required:!0,status:(M=s==null?void 0:s.key)==null?void 0:M.status,value:p.key,wrapperClassName:"mb-2"}),n(Q,{disabled:j,invalidMessage:(_=s==null?void 0:s.value)==null?void 0:_.invalidMessage,label:o("Value"),onChange:b=>I("value",b.target.value),required:!0,status:(O=s==null?void 0:s.value)==null?void 0:O.status,value:p.value,wrapperClassName:"mb-2"}),e&&n(Z,{disabled:j,invalidMessage:(F=s==null?void 0:s.addTo)==null?void 0:F.invalidMessage,label:o("Add to"),onChange:b=>I("addTo",b),options:[{label:o("Header"),value:"header"},{label:o("Query Params"),value:"query_params"}],required:!0,status:(S=s==null?void 0:s.addTo)==null?void 0:S.status,value:p.addTo,wrapperClassName:"mb-2"}),((z=s==null?void 0:s.saveConnection)==null?void 0:z.status)==="error"&&n(X.Paragraph,{type:"danger",children:(w=s==null?void 0:s.saveConnection)==null?void 0:w.invalidMessage}),x(G,{gap:8,justify:"end",children:[n(K,{onClick:()=>h(!1),children:o("Cancel")}),n(K,{disabled:j,htmlType:"submit",loading:j,type:"primary",children:o("Connect")})]})]})}globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(t,a){return this.cache.has(t)?this.cache.get(t):(this.cache.set(t,a),a)}};globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(t,a){return this.cache.has(t)?this.cache.get(t):(this.cache.set(t,a),a)}};const qe={password:"",type:"basic_auth",username:""};function kt({children:t,connectionConfig:a,connectionName:c}){var _,O,F,S,z,w;const[e,s]=l.useState(),[i,r]=l.useState(!1),{saveConnection:h}=se(),{setIsPopoverOpen:p}=l.useContext(J),[C,D]=l.useState(qe),{appSlug:E,extraData:j,isConnecting:f,onConnectionAddChange:u,onConnectionChange:v,onConnectionSaveClick:A,onValidate:U,setIsConnecting:I}=l.useContext(B),V=b=>{const{name:q,value:k}=b.target;D(d=>{const T={...d,[q]:k};return u==null||u(T),T})},m=async(b,q)=>{try{const{data:k}=await h({app_slug:E,auth_details:b,auth_type:C.type,connection_name:c,encrypt_keys:q});p(!1),D(qe),v==null||v(k.id)}catch(k){console.error("Error in saving connection",k),s({saveConnection:{invalidMessage:"Can't save connection",status:"error"}})}},P=async b=>{if(b.preventDefault(),s(void 0),U&&U(C)===!1)return;A==null||A(C),I(!0),await ne(a.verifyConnection)?await m({password:C.password,username:C.username,...j&&{extraData:j}},a.encryptKeys):s({password:{invalidMessage:"Invalid username or password",status:"error"},username:{status:"error"}}),I(!1)},M=()=>r(b=>!b);return x("form",{onSubmit:P,children:[t,(a==null?void 0:a.showUsername)!==!1&&n(Q,{disabled:f,invalidMessage:(_=e==null?void 0:e.username)==null?void 0:_.invalidMessage,label:o("Key / Username"),name:"username",onChange:V,required:!0,status:(O=e==null?void 0:e.username)==null?void 0:O.status,value:C.username,wrapperClassName:"mb-2"}),(a==null?void 0:a.showPassword)!==!1&&x(Re.Compact,{className:"w-full",children:[n(Q,{disabled:f,invalidMessage:(F=e==null?void 0:e.password)==null?void 0:F.invalidMessage,label:o("Secret / Password"),name:"password",onChange:V,required:!0,status:(S=e==null?void 0:e.password)==null?void 0:S.status,type:i?"text":"password",value:C.password,wrapperClassName:"mb-2 w-full"}),n(K,{className:"mt-[1.625rem]",icon:i?n(et,{}):n(tt,{}),onClick:M})]}),((z=e==null?void 0:e.saveConnection)==null?void 0:z.status)==="error"&&n(X.Paragraph,{type:"danger",children:(w=e==null?void 0:e.saveConnection)==null?void 0:w.invalidMessage}),x(G,{gap:8,justify:"end",children:[n(K,{onClick:()=>p(!1),children:o("Cancel")}),n(K,{disabled:f,htmlType:"submit",loading:f,type:"primary",children:o("Connect")})]})]})}globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(t,a){return this.cache.has(t)?this.cache.get(t):(this.cache.set(t,a),a)}};globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(t,a){return this.cache.has(t)?this.cache.get(t):(this.cache.set(t,a),a)}};function At(t,a,c){const e={inputs:a,label:(c==null?void 0:c.label)||""},s=W(t,h=>{h.push(dt(e))}),i=ce(s),r=s.length-1;return{inputGroup:e,inputGroupIndex:r,newRepeaterField:s,values:i}}function xe(t,a,c){const e=new Map(a.map(s=>[s.name,s]));return t.map(s=>({inputs:s.map(i=>{const r=e.get(i.name);return r?at(r,i):i}),label:(c==null?void 0:c.label)||""}))}function jt(t,a){const c=t[a],e=W(t,i=>{i.splice(a,1)}),s=ce(e);return{inputGroup:c,repeaterFieldAfterDelete:e,values:s}}function _t(t,a,c,e){const s=W(t,r=>{const h=r[a].inputs[c];h.value=e,h.required&&(Array.isArray(e)&&e.length===0||!e)&&(h.invalidMessage=`${h.label} is required`)}),i=ce(s);return{updatedRepeaterField:s,values:i}}function St(t){return t.componentName===ae.input}function Nt(t){return t.componentName===ae.mixInput}function Et(t){return t.componentName===ae.select}function ce(t){return t.map(a=>a.inputs.map(({disabled:c,name:e="",value:s})=>{const i={name:e,value:s};return c&&(i.disabled=c),i}))}globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(t,a){return this.cache.has(t)?this.cache.get(t):(this.cache.set(t,a),a)}};const{Paragraph:It,Text:Pt}=X;function qt({addItemButtonLabel:t,additionalActions:a,deleteBtnProps:c,direction:e,fieldsMetaData:s,helperText:i,inputGroupProps:r,label:h,labelActionIconName:p,labelActionLoading:C,labelActionOnClick:D,labelActionText:E,maxGroup:j,minGroup:f=0,nonRemovableRows:u,onChange:v,onDelete:A,onRender:U,value:I,wrapperClassName:V}){const[m,P]=l.useState([]),{token:M}=Oe.useToken(),_=()=>m.length<=f,O=()=>j!==void 0&&m.length>=j,F=l.useRef(!1);l.useEffect(()=>{const d=setTimeout(()=>{F.current=!0},100);return()=>{F.current=!1,clearTimeout(d)}},[]);const S=()=>{if(O())return;const{inputGroup:d,inputGroupIndex:T,newRepeaterField:R,values:$}=At(m,s,r);P(R),v($,d,T)},z=d=>()=>{if(_())return;const{inputGroup:T,repeaterFieldAfterDelete:R,values:$}=jt(m,d);P(R),v($,T,d),A==null||A(d)},w=(d,T,R)=>{const{updatedRepeaterField:$,values:H}=_t(m,d,T,R);P($);const Y=$[d];v(H,Y,d,T)},b=(d,T)=>R=>{const{value:$}=R.target;w(T,d,$)},q=(d,T)=>R=>{w(T,d,R)},k=(d,T)=>R=>{w(T,d,R)};return l.useEffect(()=>{P(xe(I||[],s,r))},[s]),l.useEffect(()=>{P(xe(I||[],s,r))},[I]),l.useEffect(()=>{U==null||U()},[]),x("div",{className:V,"data-testid":"repeater",children:[x(G,{className:_e([!i&&"mb-1"]),justify:"space-between",children:[h&&n("label",{className:"d-ib font-medium",css:Fe({color:M.colorText},"",""),htmlFor:"repeater",children:h}),(E||p)&&n(K,{"aria-label":typeof E=="string"&&E||o("label-action"),icon:p&&n(st,{}),loading:C,onClick:D,size:"small",children:E})]}),i&&n(It,{className:"mb-1",type:"secondary",children:i}),x(nt,{children:[m.map((d,T)=>x(Se.div,{animate:{height:"auto",opacity:1},"data-testid":"repeater-input-group",exit:{height:0,opacity:0},initial:F.current&&{height:0,opacity:0},transition:{duration:.2},children:[x("div",{className:"mb-1 ml-3 flex items-center justify-between",children:[x(Pt,{children:[d!=null&&d.label&&d.label.includes("#{COUNT}")?d.label.replace("#{COUNT}",String(T+1)):d.label,!(d!=null&&d.label)&&it(o("Item %d"),T+1)]}),x("div",{className:"flex items-center gap-2",children:[!(u!=null&&u.includes(T))&&n(K,{className:c==null?void 0:c.className,"data-testid":"delete-item",disabled:_(),icon:n(ct,{}),onClick:z(T),size:"small",style:c==null?void 0:c.style}),a==null?void 0:a(T)]})]}),n("div",{className:_e(["mb-3 ml-6",r==null?void 0:r.className,e==="vertical"?"space-y-2":"flex gap-2"]),style:r==null?void 0:r.style,children:d.inputs.map((R,$)=>{if(St(R)){const{componentName:H,...Y}=R;return n(Q,{onChange:b($,T),...Y},`${H}_${$+10}`)}if(Et(R)){const{componentName:H,...Y}=R;return n(Z,{onChange:q($,T),...Y},`${H}_${$+10}`)}if(Nt(R)){const{componentName:H,...Y}=R;return n(Ct,{onChange:k($,T),...Y},`${H}_${$+10}`)}})})]},`inputGroup-${T+10}`)),n(Se.div,{layout:!0,transition:{duration:.2},children:n(K,{"data-testid":"add-item",disabled:O(),icon:n(ot,{}),onClick:S,children:t})})]})]})}globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(t,a){return this.cache.has(t)?this.cache.get(t):(this.cache.set(t,a),a)}};globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(t,a){return this.cache.has(t)?this.cache.get(t):(this.cache.set(t,a),a)}};const xt={clientAuthentication:"header"},Ut=[[{name:"key",value:""},{name:"value",value:""}]];function Ot({children:t,connectionConfig:a,connectionName:c}){var q,k,d,T,R,$,H,Y,oe,le,re,he,ue,de,pe,me,Ce,ye,fe,ve,be,ge,we,Te,ke,Ae;const[e,s]=l.useState(),{saveConnection:i}=se(),[r,h]=$e(Ke),{setIsPopoverOpen:p}=l.useContext(J),[C,D]=l.useState(xt),E=l.useRef(Ut),{appSlug:j,extraData:f,isConnecting:u,onConnectionChange:v,onValidate:A,setIsConnecting:U}=l.useContext(B),I=l.useRef(""),V=l.useRef(""),[m,P]=l.useState(a),M=(y,N)=>{D(g=>W(g,L=>{L[y]=N}))},_=y=>N=>{P(g=>W(g,L=>{switch(L.tokenEndpoint.bodyParams||(L.tokenEndpoint.bodyParams={}),L.authCodeEndpoint.queryParams||(L.authCodeEndpoint.queryParams={}),y){case"authUrl":{L.authCodeEndpoint.url=N;break}case"clientId":{L.authCodeEndpoint.queryParams.client_id=N,I.current=N;break}case"clientSecret":{V.current=N;break}case"grantType":{L.tokenEndpoint.bodyParams.grant_type=N;break}case"scope":{L.authCodeEndpoint.queryParams.scope=N;break}case"tokenUrl":{L.tokenEndpoint.url=N;break}}}))},O=y=>{E.current=y},F=()=>{const y=E.current.reduce((N,g)=>{var te,je;const L=(te=g==null?void 0:g[0])==null?void 0:te.value,ee=(je=g==null?void 0:g[1])==null?void 0:je.value;return L&&ee&&(N[L]=ee),N},{});y&&Object.keys(y).length>0&&P(N=>W(N,g=>{g.authCodeEndpoint.queryParams||(g.authCodeEndpoint.queryParams={}),Object.assign(g.authCodeEndpoint.queryParams,y)})),P(N=>W(N,g=>{var L,ee,te;C.clientAuthentication==="header"?(g.tokenEndpoint.headers||(g.tokenEndpoint.headers={}),g.tokenEndpoint.headers.Authorization=["Basic ",{encryption:"base64_encode",value:`${I.current}:${V.current}`}],(L=g.tokenEndpoint.bodyParams)==null||delete L.client_id,(ee=g.tokenEndpoint.bodyParams)==null||delete ee.client_secret):(g.tokenEndpoint.bodyParams||(g.tokenEndpoint.bodyParams={}),g.tokenEndpoint.bodyParams.client_id=I.current,g.tokenEndpoint.bodyParams.client_secret=V.current,(te=g.tokenEndpoint.headers)==null||delete te.Authorization)}))},S=async(y,N)=>{try{const{data:g}=await i({app_slug:j,auth_details:y,auth_type:a.type,connection_name:c,encrypt_keys:N});v==null||v(g.id),P(a),p(!1)}catch(g){console.error("Can't save connection",g),s({saveConnection:{invalidMessage:"Can't save connection",status:"error"}})}},z=async()=>{F(),U(!0),Me(m,U)},w=y=>{if(y.preventDefault(),y.stopPropagation(),s(void 0),!c){s({connectionName:{invalidMessage:"Connection name is required",status:"error"}});return}A&&A(m)===!1||z()},b=async()=>{var y;try{const N=await ze(m,r);if(!N)throw new Error("Client id or secret not correct!");await S({...N,...C,...f&&{extraData:f},client_id:I.current,client_secret:V.current,refreshTokenUrl:C.refreshTokenUrl||((y=m==null?void 0:m.tokenEndpoint)==null?void 0:y.url)},m.encryptKeys)}catch(N){N instanceof Error&&s({clientId:{invalidMessage:N.message,status:"error"}}),console.error(N)}h({}),U(!1)};return Qe(()=>{Object.keys(r).length>0&&b()},400,[r]),x("form",{onSubmit:w,children:[t,n(He,{label:o("Redirect URI"),value:Le.REDIRECT_URI,wrapperClassName:"mb-2"}),n(Z,{"aria-required":!0,disabled:u,invalidMessage:(q=e==null?void 0:e.grant_type)==null?void 0:q.invalidMessage,label:o("Grant Type"),onChange:y=>_("grantType")(y),options:[{label:o("Authorization Code"),value:"authorization_code"}],required:!0,status:(k=e==null?void 0:e.grant_type)==null?void 0:k.status,value:(T=(d=m==null?void 0:m.tokenEndpoint)==null?void 0:d.bodyParams)==null?void 0:T.grant_type,wrapperClassName:"mb-2"}),n(Q,{disabled:u,invalidMessage:(R=e==null?void 0:e.authUrl)==null?void 0:R.invalidMessage,label:o("Authorization URL"),name:"authUrl",onChange:y=>_("authUrl")(y.target.value),required:!0,status:($=e==null?void 0:e.authUrl)==null?void 0:$.status,type:"url",value:(H=m==null?void 0:m.authCodeEndpoint)==null?void 0:H.url,wrapperClassName:"mb-2"}),n(Q,{disabled:u,invalidMessage:(Y=e==null?void 0:e.tokenUrl)==null?void 0:Y.invalidMessage,label:o("Token URL"),name:"tokenUrl",onChange:y=>_("tokenUrl")(y.target.value),required:!0,status:(oe=e==null?void 0:e.tokenUrl)==null?void 0:oe.status,type:"url",value:(le=m==null?void 0:m.tokenEndpoint)==null?void 0:le.url,wrapperClassName:"mb-2"}),n(Q,{disabled:u,helperText:o("if not provided, the token URL will be used to refresh the token"),invalidMessage:(re=e==null?void 0:e.refreshTokenUrl)==null?void 0:re.invalidMessage,label:o("Refresh Token URL"),name:"refreshTokenUrl",onChange:y=>M("refreshTokenUrl",y.target.value),status:(he=e==null?void 0:e.refreshTokenUrl)==null?void 0:he.status,type:"url",value:C==null?void 0:C.refreshTokenUrl,wrapperClassName:"mb-2"}),n(Q,{disabled:u,invalidMessage:(ue=e==null?void 0:e.clientId)==null?void 0:ue.invalidMessage,label:o("Client Id"),name:"clientId",onChange:y=>_("clientId")(y.target.value),required:!0,status:(de=e==null?void 0:e.clientId)==null?void 0:de.status,wrapperClassName:"mb-2"}),n(Q,{disabled:u,invalidMessage:(pe=e==null?void 0:e.clientSecret)==null?void 0:pe.invalidMessage,label:o("Client Secret"),name:"clientSecret",onChange:y=>_("clientSecret")(y.target.value),required:!0,status:(me=e==null?void 0:e.clientSecret)==null?void 0:me.status,wrapperClassName:"mb-2"}),n(Q,{disabled:u,invalidMessage:(Ce=e==null?void 0:e.scope)==null?void 0:Ce.invalidMessage,label:o("Scope"),name:"scope",onChange:y=>_("scope")(y.target.value),status:(ye=e==null?void 0:e.scope)==null?void 0:ye.status,value:(ve=(fe=m==null?void 0:m.authCodeEndpoint)==null?void 0:fe.queryParams)==null?void 0:ve.scope,wrapperClassName:"mb-2"}),n(qt,{addItemButtonLabel:o("Add"),fieldsMetaData:[{componentName:ae.input,name:"key",placeholder:o("Key"),value:""},{componentName:ae.input,name:"value",placeholder:o("Value"),value:""}],label:o("Additional Query Params"),minGroup:1,onChange:O,value:E.current,wrapperClassName:"mb-2"}),n(Z,{disabled:u,invalidMessage:(be=e==null?void 0:e.clientAuthentication)==null?void 0:be.invalidMessage,label:o("Client Authentication"),onChange:y=>M("clientAuthentication",y),options:[{label:o("Send as Basic Auth header"),value:"header"},{label:o("Send Client Credentials in body"),value:"body"}],required:!0,status:(ge=e==null?void 0:e.clientAuthentication)==null?void 0:ge.status,value:C.clientAuthentication,wrapperClassName:"mb-2"}),((we=e==null?void 0:e.saveConnection)==null?void 0:we.status)==="error"&&n(X.Paragraph,{type:"danger",children:(Te=e==null?void 0:e.saveConnection)==null?void 0:Te.invalidMessage}),((ke=e==null?void 0:e.connectionName)==null?void 0:ke.status)==="error"&&n(X.Paragraph,{type:"danger",children:(Ae=e==null?void 0:e.connectionName)==null?void 0:Ae.invalidMessage}),x(G,{gap:8,justify:"end",children:[n(K,{onClick:()=>p(!1),children:o("Cancel")}),n(K,{disabled:u,htmlType:"submit",loading:u,type:"primary",children:o("Connect")})]})]})}globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(t,a){return this.cache.has(t)?this.cache.get(t):(this.cache.set(t,a),a)}};globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(t,a){return this.cache.has(t)?this.cache.get(t):(this.cache.set(t,a),a)}};const{Text:Ft}=X;function Rt({children:t}){const[a,c]=l.useState(""),[e,s]=l.useState(""),{addConnectionHelpingText:i,appName:r,connectionsTypes:h,customConnection:p,isConnecting:C}=l.useContext(B),D=l.useMemo(()=>h.map(u=>({label:u.label,value:u.type})),[h]),E=u=>{const{value:v}=u.target;c(v)},j=u=>{s(u)},f=u=>{const v=h.find(A=>A.type===u);if(!v)throw new Error("Connection type not found");return v};return l.useEffect(()=>{r&&c(`${r} connection`)},[r]),l.useEffect(()=>{h.length===1&&s(h[0].type)},[]),x(Ve,{children:[n(Z,{"aria-readonly":(h==null?void 0:h.length)===1,disabled:C||(h==null?void 0:h.length)===1,label:o("Connection type"),onChange:j,options:D,placeholder:o("Choose type"),value:e,wrapperClassName:"mb-2"}),n(Q,{disabled:C,label:o("Connection Name"),name:"connectionName",onChange:E,required:!0,value:a,wrapperClassName:"mb-2"}),i&&n("div",{className:"mb-2",children:n(Ft,{type:"secondary",children:n("span",{dangerouslySetInnerHTML:{__html:i}})})}),p&&e==="oauth2"&&n(Ot,{connectionConfig:f("oauth2"),connectionName:a,children:t}),!p&&e==="oauth2"&&n(wt,{connectionConfig:f("oauth2"),connectionName:a,children:t}),e==="bearer_token"&&n(ft,{connectionConfig:f("bearer_token"),connectionName:a,children:t}),e==="api_key"&&n(Tt,{connectionConfig:f("api_key"),connectionName:a,customConnection:p,children:t}),e==="basic_auth"&&n(kt,{connectionConfig:f("basic_auth"),connectionName:a,children:t})]})}globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(t,a){return this.cache.has(t)?this.cache.get(t):(this.cache.set(t,a),a)}};function Dt({children:t}){const{isPopoverOpen:a,setIsPopoverOpen:c}=l.useContext(J),e=()=>{c(i=>!i)};return n(yt,{content:n(Rt,{children:t}),destroyTooltipOnHide:!0,open:a,placement:"right",styles:{body:{maxHeight:"100vh",maxWidth:400,overflowY:"auto"}},title:n($t,{popoverClose:()=>{c(!1)}}),children:n(De,{title:o("Add new connection"),children:n(K,{onClick:e,children:o("Add Connection")})})})}function $t({popoverClose:t}){return x(pt,{justify:"space-between",children:[n(X.Title,{level:5,style:{marginBottom:0},children:o("Add New Connection")}),n(K,{icon:n(lt,{}),onClick:t,size:"small",type:"text"})]})}globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(t,a){return this.cache.has(t)?this.cache.get(t):(this.cache.set(t,a),a)}};function Zt({addConnectionHelpingText:t,allowClear:a,appName:c,appSlug:e,children:s,connectionOptionsProp:i,connectionsTypes:r,customConnection:h,extraData:p,helpingText:C,invalidMessage:D,label:E=o("Connection"),loading:j=!1,onConnectionAddChange:f,onConnectionChange:u,onConnectionSaveClick:v,onRender:A,onValidate:U,status:I,value:V,wrapperClassName:m}){const[P,M]=l.useState(!1),[_,O]=l.useState(!1),{id:F}=ie(Ue),{states:S}=ie(ut(F)),z=l.useMemo(()=>{var k;return(k=S==null?void 0:S.connections)==null?void 0:k.map(d=>({label:d.connection_name,value:d.id}))},[S==null?void 0:S.connections]),w=l.useMemo(()=>({isPopoverOpen:_,setIsPopoverOpen:O}),[_]),b=l.useMemo(()=>({addConnectionHelpingText:t,appName:c,appSlug:e,connectionsTypes:r,customConnection:h,extraData:p,isConnecting:P,onConnectionAddChange:f,onConnectionChange:u,onConnectionSaveClick:v,onValidate:U,setIsConnecting:M}),[t,c,e,r,h,p,P,f,u,v,U]),q=k=>{u==null||u(k)};return l.useEffect(()=>{A==null||A()},[]),n(Z,{allowClear:a,disabled:j||_,helperText:C,invalidMessage:D,label:E,loading:j,onChange:q,optionFilterProp:"label",options:i||z,placeholder:o("Choose a connection"),showSearch:!0,status:I,suffix:n(B.Provider,{value:b,children:n(J.Provider,{value:w,children:n(Dt,{children:s})})}),value:V,wrapperClassName:`w-100 ${m}`})}globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(t,a){return this.cache.has(t)?this.cache.get(t):(this.cache.set(t,a),a)}};export{Zt as C,He as I,qt as R};
