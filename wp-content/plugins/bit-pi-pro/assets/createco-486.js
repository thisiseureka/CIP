import{a3 as p,a4 as c}from"./_applist-952.js";import{dx as u,_ as i}from"./main-red-poems-invite.js";import{s as h}from"./machine.-578.js";import"./lodash-840.js";import"./mutative-12.js";globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(t,e){return this.cache.has(t)?this.cache.get(t):(this.cache.set(t,e),e)}};const C=async t=>u({bodyParams:{limit:100,page:1},headers:{Authorization:{encryption:"hmac_decrypt",value:t},"Content-Type":"application/json"},method:"POST",url:"https://cloudapi.mailercloud.com/v1/lists/search"}),g=async t=>u({bodyParams:{limit:100,page:1},headers:{Authorization:{encryption:"hmac_decrypt",value:t},"Content-Type":"application/json"},method:"POST",url:"https://cloudapi.mailercloud.com/v1/tags/search"}),T=async t=>u({bodyParams:{limit:100,page:1},headers:{Authorization:{encryption:"hmac_decrypt",value:t},"Content-Type":"application/json"},method:"POST",url:"https://cloudapi.mailercloud.com/v1/contact/property/search"});globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(t,e){return this.cache.has(t)?this.cache.get(t):(this.cache.set(t,e),e)}};const _=(t,e)=>{const n=t.getComponent("list-id");!e.isSelectComponent(n)||!n.value||!n.options||n.options.some(o=>o.value===n.value)||(t.setComponent("list-id",o=>{o.value=void 0}),t.setDb(o=>{o.listId=void 0}))},r=async t=>{t.setComponent("list-id",a=>{a.loading=!0});const e=await t.getConnection();if(!e){t.setComponent("list-id",a=>{a.loading=!1});return}const{data:n,status:o}=await C(e.auth_details.value);if(o==="error"){t.setComponent("list-id",a=>{t.util.isSelectComponent(a)&&(a.status=o,a.invalidMessage=n)}),console.error("Failed to fetch lists");return}t.setComponent("list-id",a=>{var s;t.util.isSelectComponent(a)&&(a.options=(s=n==null?void 0:n.data)==null?void 0:s.map(l=>({label:l.name,value:l.id})),a.loading=!1,a.status=void 0)})},d=async t=>{t.setComponent("tag-id",a=>{a.loading=!0});const e=await t.getConnection();if(!e){t.setComponent("tag-id",a=>{a.loading=!1});return}const{data:n,status:o}=await g(e.auth_details.value);if(o==="error"){t.setComponent("tag-id",a=>{t.util.isSelectComponent(a)&&(a.status=o,a.invalidMessage=n)}),console.error("Failed to fetch tags");return}t.setComponent("tag-id",a=>{var s;t.util.isSelectComponent(a)&&(a.options=(s=n==null?void 0:n.data)==null?void 0:s.map(l=>({label:l.tag_name,value:l.tag_name})),a.loading=!1,a.status=void 0)})},f=t=>{const e=[];return Array.isArray(t==null?void 0:t.data)?[...t.data].sort((o,a)=>o.field_name==="Email"?-1:a.field_name==="Email"?1:0).forEach(o=>{o!=null&&o.field_name&&(o!=null&&o.field_value)?e.push({label:o.field_name,value:o.field_value}):console.warn("Invalid field encountered:",o)}):console.warn("No ContactFields found in data or ContactFields is not an array."),e},m=async t=>{t.setComponent("contact-data",o=>{o.loading=!0});const e=await t.getConnection();if(!e){t.setComponent("contact-data",o=>{o.loading=!1});return}const{data:n}=await T(e.auth_details.value);t.setComponent("contact-data",o=>{if(!t.util.isRepeaterFieldComponent(o))return;const a=o.fieldsMetaData[0];a.options=f(n),o.loading=!1})};globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(t,e){return this.cache.has(t)?this.cache.get(t):(this.cache.set(t,e),e)}};const A=p(({helpers:t})=>({states:{components:[{addConnectionHelpingText:i('You can get your API key from <a class="text-blue-600 underline" href="https://app.mailercloud.com/account/api-integrations" target="_blank" rel="noopener noreferrer nofollow">here</a>'),componentName:t.componentName.connection,connectionsTypes:[{encryptKeys:["value"],label:i("API Key"),showKey:!1,type:"api_key",verifyConnection:{headers:{Authorization:""},method:"GET",responseKeyMatch:["data"],url:"https://cloudapi.mailercloud.com/v1/client/plan"}}],fieldType:"config",id:"connection-id",label:i("Select Connection"),onConnectionAddChange:"CONNECTION_ADD_CHANGE",onConnectionChange:"SET_CONNECTION",render:!0,value:void 0},{componentName:t.componentName.select,fieldType:"config",id:"list-id",label:i("Lists"),onChange:"SELECT_LIST",onRefetch:"REFETCH_LIST",optionFilterProp:"label",options:[],placeholder:i("Select a list"),render:"IF_CONNECTION_SELECTED",showSearch:!0,value:void 0},{componentName:t.componentName.select,fieldType:"config",id:"tag-id",label:i("Tags"),mode:"multiple",onChange:"SELECT_TAG",onRefetch:"REFETCH_TAG",optionFilterProp:"label",options:[],placeholder:i("Select a tag"),render:"IF_LIST_SELECTED",showSearch:!0,value:void 0},{addItemButtonLabel:"Add Column",componentName:t.componentName.repeaterField,fieldsMetaData:[{componentName:t.componentName.select,label:i("Column"),name:"column",options:[],required:!0,showSearch:!0,style:{width:200},value:""},{componentName:t.componentName.mixInput,label:i("Value"),name:"value",required:!0,value:[],wrapperClassName:"w-100"}],id:"contact-data",label:i("Field Mapping"),nonRemovableRows:[0],onChange:"ON_CHANGE_ROW_DATA",path:"rowData",render:"IF_LIST_SELECTED",value:[[{disabled:!0,name:"column",value:"email"},{name:"value",value:[]}]]}]},actions:{CONNECTION_ADD_CHANGE:({$:e,e:n})=>{e.setThisComponent(o=>{e.util.isConnectionComponent(o)&&o.connectionsTypes.forEach(a=>{var s;a.type==="api_key"&&((s=a.verifyConnection)!=null&&s.headers)&&(a.verifyConnection.headers.Authorization=n.value)})})},IF_CONNECTION_SELECTED:({$:e})=>{var n;return c((n=e.getComponent("connection-id"))==null?void 0:n.value)},IF_LIST_SELECTED:({$:e})=>{var n;return c((n=e.getComponent("list-id"))==null?void 0:n.value)},IF_TAG_SELECTED:({$:e})=>{var n;return c((n=e.getComponent("tag-id"))==null?void 0:n.value)},ON_CHANGE_ROW_DATA:({$:e,e:n})=>{e.setThisComponent(o=>{o.value=n}),e.setDb(o=>{o.rowData=n})},ON_MACHINE_LOAD:async({$:e})=>{h(e,[{db:"connectionId",id:"connection-id"},{db:"listId",id:"list-id"},{db:"tagId",id:"tag-id"},{db:"rowData",id:"contact-data"}]),await Promise.all([r(e),d(e),m(e)])},REFETCH_LIST:async({$:e})=>{await r(e)},REFETCH_TAG:async({$:e})=>{await d(e)},SELECT_LIST:async({$:e,e:n})=>{e.setThisComponent(o=>{o.value=n}),e.setComponent("list-title",o=>{o.value=void 0}),e.setDb(o=>{o.listId=n,o.listTitle=void 0})},SELECT_TAG:async({$:e,e:n})=>{e.setThisComponent(o=>{o.value=n}),e.setComponent("tag-title",o=>{o.value=void 0}),e.setDb(o=>{o.tagId=n,o.tagTitle=void 0})},SET_CONNECTION:async({$:e,e:n})=>{e.setThisComponent(o=>{o.value=n}),e.setDb(o=>{o.connectionId=n}),_(e,t),Promise.all([r(e),d(e),m(e)])}}}));export{A as default};
