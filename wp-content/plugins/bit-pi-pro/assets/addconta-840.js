import{a3 as C,a4 as u}from"./_applist-952.js";import{dx as p,_ as i}from"./main-red-poems-invite.js";import{s as h}from"./machine.-578.js";import"./lodash-840.js";import"./mutative-12.js";globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(o,t){return this.cache.has(o)?this.cache.get(o):(this.cache.set(o,t),t)}};const g=async o=>p({headers:{Authorization:["Bearer ",{encryption:"hmac_decrypt",value:o}]},method:"GET",url:"https://api.emailoctopus.com/lists/"}),E=async(o,t)=>p({headers:{Authorization:["Bearer ",{encryption:"hmac_decrypt",value:o}]},method:"GET",url:`https://api.emailoctopus.com/lists/${t}`});globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(o,t){return this.cache.has(o)?this.cache.get(o):(this.cache.set(o,t),t)}};const c=async o=>{o.setComponent("list-id",e=>{e.loading=!0});const t=await o.getConnection();if(!t){o.setComponent("list-id",e=>{e.loading=!1});return}const{data:a}=await g(t.auth_details.value);if(!("data"in a)||!Array.isArray(a.data)){o.setComponent("list-id",e=>{o.util.isSelectComponent(e)&&(e.loading=!1,e.status="error",e.invalidMessage=i("Failed to fetch lists"))});return}o.setComponent("list-id",e=>{var s;o.util.isSelectComponent(e)&&(e.options=((s=a==null?void 0:a.data)==null?void 0:s.map(n=>({label:n.name,value:n.id})))||[],e.loading=!1,e.status=void 0)})},d=async o=>{var s;o.setComponent("field-map",n=>{n.loading=!0,o.util.isRepeaterFieldComponent(n)&&(n.labelActionLoading=!0)}),o.setComponent("tags",n=>{n.loading=!0});const t=await o.getConnection(),a=(s=o.getComponent("list-id"))==null?void 0:s.value;if(!t||!a){o.setComponent("field-map",n=>{n.loading=!1,o.util.isRepeaterFieldComponent(n)&&(n.labelActionLoading=!1)}),o.setComponent("tags",n=>{n.loading=!1});return}const{data:e}=await E(t.auth_details.value,a);if(!("fields"in e)||!("tags"in e)||!Array.isArray(e.fields)){o.setComponent("field-map",n=>{n.loading=!1,o.util.isRepeaterFieldComponent(n)&&(n.labelActionLoading=!1)}),o.setComponent("tags",n=>{o.util.isSelectComponent(n)&&(n.loading=!1,n.status="error",n.invalidMessage=i("Failed to fetch tags"))});return}o.setComponent("field-map",n=>{var r;if(!o.util.isRepeaterFieldComponent(n))return;const l=n.fieldsMetaData[0];l.options=((r=e==null?void 0:e.fields)==null?void 0:r.map(m=>({label:m.label,value:m.tag})))||[],n.loading=!1,o.util.isRepeaterFieldComponent(n)&&(n.labelActionLoading=!1)}),o.setComponent("tags",n=>{o.util.isSelectComponent(n)&&(n.options=(e==null?void 0:e.tags.map(l=>({label:l,value:l})))||[],n.loading=!1,n.status=void 0)})},T=(o,t)=>{const a=o.getComponent("list-id");!t.isSelectComponent(a)||!a.value||!a.options||a.options.some(e=>e.value===a.value)||(o.setComponent("list-id",e=>{e.value=void 0}),o.setDb(e=>{e.listId=void 0}))};globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(o,t){return this.cache.has(o)?this.cache.get(o):(this.cache.set(o,t),t)}};const I=C(({helpers:o})=>({states:{components:[{addConnectionHelpingText:i("You can get your API key from")+' <a class="text-blue-600 underline" href="https://emailoctopus.com/developer/api-keys" target="_blank" rel="noopener noreferrer nofollow">'+i("here")+"</a>",componentName:o.componentName.connection,connectionsTypes:[{encryptKeys:["value"],label:i("API Key"),showKey:!1,type:"api_key",verifyConnection:{headers:{Authorization:""},method:"GET",responseKeyMatch:["data","paging"],url:"https://api.emailoctopus.com/lists/"}}],fieldType:"config",id:"connection-id",label:i("Select Connection"),onConnectionAddChange:"CONNECTION_ADD_CHANGE",onConnectionChange:"SET_CONNECTION",render:!0,value:void 0},{componentName:o.componentName.select,fieldType:"config",id:"list-id",label:i("List"),onChange:"HANDLE_LIST_ID",onRefetch:"REFETCH_LISTS",options:[],path:"listId",placeholder:i("Select a list"),render:"IF_CONNECTION_SELECTED",value:void 0},{addItemButtonLabel:i("Add Item"),componentName:o.componentName.repeaterField,fieldsMetaData:[{componentName:o.componentName.select,label:i("Field"),name:"emailOctopusField",optionFilterProp:"label",options:[],required:!0,showSearch:!0,value:void 0,wrapperClassName:"w-100"},{componentName:o.componentName.mixInput,label:i("Value"),name:"value",required:!0,value:[],wrapperClassName:"w-100"}],id:"field-map",label:i("Field Map"),labelActionIconName:"refresh-cw",labelActionOnClick:"REFETCH_FIELDS_AND_TAGS",labelActionText:i("Refetch Fields & Tags"),loading:!1,nonRemovableRows:[0],onChange:"ON_CHANGE_FIELD_MAP",render:"IF_LIST_SELECTED",value:[[{disabled:!0,name:"emailOctopusField",value:"EmailAddress"},{name:"value",value:[]}]],wrapperClassName:"mt-3"},{componentName:o.componentName.select,id:"tags",label:i("Tags"),mode:"multiple",onChange:"HANDLE_TAGS",options:[],path:"tags",placeholder:i("Select Tags to attach with the contact."),render:"IF_LIST_SELECTED",value:void 0},{componentName:o.componentName.select,id:"status",label:i("Status"),onChange:"HANDLE_STATUS",options:[{label:i("Subscribed"),value:"subscribed"},{label:i("Unsubscribed"),value:"unsubscribed"},{label:i("Pending"),value:"pending"}],path:"status",render:"IF_LIST_SELECTED",value:"subscribed"},{componentName:o.componentName.select,helperText:i("Override the existing contact info by responses."),id:"override-existing",label:i("Override Existing"),onChange:"HANDLE_OVERRIDE_EXISTING",options:[{label:i("Yes"),value:"yes"},{label:i("No"),value:"no"}],path:"overrideExisting",render:"IF_LIST_SELECTED",value:"no"}]},actions:{ON_MACHINE_LOAD:async({$:t})=>{h(t,[{db:"connectionId",id:"connection-id"},{db:"listId",id:"list-id"},{db:"fieldMap",id:"field-map"},{db:"tags",id:"tags"},{db:"status",id:"status"},{db:"overrideExisting",id:"override-existing"}]),await Promise.all([c(t),d(t)])},CONNECTION_ADD_CHANGE:({$:t,e:a})=>{t.setThisComponent(e=>{t.util.isConnectionComponent(e)&&e.connectionsTypes.forEach(s=>{var n;s.type==="api_key"&&((n=s.verifyConnection)!=null&&n.headers)&&(s.verifyConnection.headers.Authorization="Bearer "+a.value)})})},HANDLE_LIST_ID:async({$:t,e:a})=>{t.setThisComponent(e=>{e.value=a}),t.setDb(e=>{e.listId=a}),await d(t)},HANDLE_OVERRIDE_EXISTING:({$:t,e:a})=>{t.setThisComponent(e=>{e.value=a}),t.setDb(e=>{e.overrideExisting=a})},HANDLE_TAGS:({$:t,e:a})=>{t.setThisComponent(e=>{e.value=a}),t.setDb(e=>{e.tags=a})},HANDLE_MIX_INPUT:({$:t,e:a})=>{t.setThisComponent(e=>{e.value=a})},HANDLE_STATUS:({$:t,e:a})=>{t.setThisComponent(e=>{e.value=a}),t.setDb(e=>{e.status=a})},IF_CONNECTION_SELECTED:({$:t})=>{var a;return u((a=t.getComponent("connection-id"))==null?void 0:a.value)},IF_LIST_SELECTED:({$:t})=>{var a;return u((a=t.getComponent("list-id"))==null?void 0:a.value)},ON_CHANGE_FIELD_MAP:({$:t,e:a})=>{t.setThisComponent(e=>{e.value=a}),t.setDb(e=>{e.fieldMap=a})},SET_CONNECTION:async({$:t,e:a})=>{t.setThisComponent(e=>{e.value=a}),t.setDb(e=>{e.connectionId=a}),await c(t),T(t,o)},REFETCH_FIELDS_AND_TAGS:async({$:t})=>{await d(t)},REFETCH_LISTS:async({$:t})=>{await c(t)}}}));export{I as default};
