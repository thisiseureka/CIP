import{a3 as p,a4 as u}from"./_applist-952.js";import{dx as m,_ as a}from"./main-red-poems-invite.js";import{s as h}from"./machine.-578.js";import"./lodash-840.js";import"./mutative-12.js";globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(t,e){return this.cache.has(t)?this.cache.get(t):(this.cache.set(t,e),e)}};const C="https://apiv3.emailsys.net/v1",f=async(t,e)=>m({headers:{Accept:"*/*",Authorization:["Basic ",{encryption:"base64_encode",value:[t,":",{encryption:"hmac_decrypt",value:e}]}]},method:"GET",url:`${C}/recipientlists`});globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(t,e){return this.cache.has(t)?this.cache.get(t):(this.cache.set(t,e),e)}};const r=async t=>{t.setComponent("list-id",o=>{o.loading=!0});const e=await t.getConnection();if(!e){t.setComponent("list-id",o=>{o.loading=!1});return}const{password:i,username:n}=e.auth_details,{data:l,status:s}=await f(n,i);if(s==="error"){t.setComponent("list-id",o=>{t.util.isSelectComponent(o)&&(o.status=s,o.invalidMessage=l)}),console.error("Failed to fetch contact list");return}t.setComponent("list-id",o=>{var c;t.util.isSelectComponent(o)&&(o.options=(c=l==null?void 0:l._embedded)==null?void 0:c.recipientlists.map(d=>({label:d.name,value:d.id})),o.loading=!1)})};globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(t,e){return this.cache.has(t)?this.cache.get(t):(this.cache.set(t,e),e)}};const g=p(({helpers:t})=>({states:{components:[{addConnectionHelpingText:a('You can get your Username and Password from <a class="text-blue-600 underline" href="https://my.rapidmail.com/api/v3/userlist.html" target="_blank" rel="noopener noreferrer nofollow">here</a>'),componentName:t.componentName.connection,connectionsTypes:[{encryptKeys:["password"],label:a("Basic Auth"),type:"basic_auth",verifyConnection:{headers:{Authorization:""},method:"GET",responseKeyMatch:["_embedded","_embedded.apiusers"],url:"https://apiv3.emailsys.net/v1/apiusers"}}],fieldType:"config",id:"connection-id",label:a("Select Connection"),onConnectionAddChange:"CONNECTION_ADD_CHANGE",onConnectionChange:"SET_CONNECTION",render:!0,value:void 0},{componentName:t.componentName.select,fieldType:"config",id:"list-id",label:a("Recipient Lists"),onChange:"SELECT_LIST",onRefetch:"REFETCH_CONTACT_LISTS",optionFilterProp:"label",options:[],placeholder:a("Select Lists"),render:"IF_CONNECTION_SELECTED",showSearch:!0,value:void 0},{componentName:t.componentName.select,fieldType:"config",helperText:a("Write and hit Enter for separate tag"),id:"recipient-tags",label:a("Recipient Tags"),mode:"tags",onChange:"ADD_RECIPIENT_TAGS",optionFilterProp:"label",options:[],placeholder:a("Add Tags"),render:"IF_CONNECTION_SELECTED",showSearch:!0,value:void 0},{addItemButtonLabel:a("Add Column"),componentName:t.componentName.repeaterField,fieldsMetaData:[{componentName:t.componentName.select,label:a("Rapidmail Field"),name:"rapidMailField",options:[{label:a("Email"),required:!0,value:"email"},{label:a("First name"),required:!1,value:"firstname"},{label:a("Last name"),required:!1,value:"lastname"},{label:a("Gender"),required:!1,value:"gender"},{label:a("Title"),required:!1,value:"title"},{label:a("Zip"),required:!1,value:"zip"},{label:a("Birthdate"),required:!1,value:"birthdate"},{label:a("Extra field 1"),required:!1,value:"extra1"},{label:a("Extra field 2"),required:!1,value:"extra2"},{label:a("Extra field 3"),required:!1,value:"extra3"},{label:a("Extra field 4"),required:!1,value:"extra4"},{label:a("Extra field 5"),required:!1,value:"extra5"},{label:a("Extra field 6"),required:!1,value:"extra6"},{label:a("Extra field 7"),required:!1,value:"extra7"},{label:a("Extra field 8"),required:!1,value:"extra8"},{label:a("Extra field 9"),required:!1,value:"extra9"},{label:a("Extra field 10"),required:!1,value:"extra10"}],required:!0,style:{width:150},value:""},{componentName:t.componentName.mixInput,label:a("Value"),name:"value",required:!0,value:[],wrapperClassName:"w-100"}],id:"contact-fields",label:a("Field Mapping"),onChange:"ON_FIELD_MAP_CHANGE",render:"IF_LIST_SELECTED",value:[]}]},actions:{ON_MACHINE_LOAD:async({$:e})=>{h(e,[{db:"connectionId",id:"connection-id"},{db:"listId",id:"list-id"},{db:"recipientTags",id:"recipient-tags"},{db:"contactFields",id:"contact-fields"}]),await r(e)},CONNECTION_ADD_CHANGE:({$:e,e:i})=>{e.setThisComponent(n=>{e.util.isConnectionComponent(n)&&n.connectionsTypes.forEach(l=>{var s;l.type==="basic_auth"&&((s=l.verifyConnection)!=null&&s.headers)&&i.username&&i.password&&(l.verifyConnection.headers.Authorization="Basic "+btoa(`${i.username}:${i.password}`))})})},REFETCH_CONTACT_LISTS:async({$:e})=>{await r(e)},ADD_RECIPIENT_TAGS:async({$:e,e:i})=>{e.setThisComponent(n=>{n.value=i}),e.setDb(n=>{n.recipientTags=i})},SELECT_LIST:async({$:e,e:i})=>{e.setThisComponent(n=>{n.value=i}),e.setDb(n=>{n.listId=i})},IF_CONNECTION_SELECTED:({$:e})=>{var i;return u((i=e.getComponent("connection-id"))==null?void 0:i.value)},IF_LIST_SELECTED:({$:e})=>{var i;return u((i=e.getComponent("list-id"))==null?void 0:i.value)},ON_FIELD_MAP_CHANGE:({$:e,e:i})=>{e.setThisComponent(n=>{n.value=i}),e.setDb(n=>{n.contactFields=i})},SET_CONNECTION:async({$:e,e:i})=>{e.setThisComponent(n=>{n.value=i}),e.setDb(n=>{n.connectionId=i}),await r(e)}}}));export{g as default};
