import{dx as h}from"./main-red-poems-invite.js";globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,o){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,o),o)}};const g=async e=>h({headers:{Authorization:["Bearer ",{encryption:"hmac_decrypt",value:e}]},method:"GET",queryParams:{q:"mimeType='application/vnd.google-apps.spreadsheet'"},url:"https://www.googleapis.com/drive/v3/files"}),m=async(e,o)=>h({headers:{Authorization:["Bearer ",{encryption:"hmac_decrypt",value:e}]},method:"GET",queryParams:{fields:"sheets.properties.title,sheets.properties.gridProperties.columnCount"},url:`https://sheets.googleapis.com/v4/spreadsheets/${o}`}),f=async(e,o,t)=>h({headers:{Authorization:["Bearer ",{encryption:"hmac_decrypt",value:e}]},method:"GET",queryParams:{dateTimeRenderOption:"FORMATTED_STRING",valueRenderOption:"FORMATTED_VALUE"},url:`https://sheets.googleapis.com/v4/spreadsheets/${o}/values/${encodeURIComponent(t)}!1:1`});globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,o){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,o),o)}};const S=(e,o)=>{const t=e.getComponent("spreadsheet-id");!o.isSelectComponent(t)||!t.value||!t.options||t.options.some(s=>s.value===t.value)||(e.setComponent("spreadsheet-id",s=>{s.value=void 0}),e.setComponent("sheet-title",s=>{s.value=void 0}),e.setDb(s=>{s.spreadsheetId=void 0,s.sheetTitle=void 0}))},b=async e=>{e.setComponent("spreadsheet-id",n=>{n.loading=!0});const o=await e.getConnection("expires_in");if(!o){e.setComponent("spreadsheet-id",n=>{n.loading=!1});return}const{data:t,status:s}=await g(o.auth_details.access_token);if(s==="error"){e.setComponent("spreadsheet-id",n=>{e.util.isSelectComponent(n)&&(n.status=s,n.invalidMessage=t)}),console.error("Failed to fetch spreadsheets");return}e.setComponent("spreadsheet-id",n=>{var i;e.util.isSelectComponent(n)&&(n.options=(i=t==null?void 0:t.files)==null?void 0:i.map(a=>({label:a.name,value:a.id})),n.loading=!1,n.status=void 0)})},R=async e=>{var n;e.setComponent("sheet-title",i=>{i.loading=!0});const o=await e.getConnection("expires_in");if(!o){e.setComponent("sheet-title",i=>{i.loading=!1});return}const{data:t,status:s}=await m(o.auth_details.access_token,(n=e.getComponent("spreadsheet-id"))==null?void 0:n.value);if(s==="error"){e.setComponent("sheet-title",i=>{e.util.isSelectComponent(i)&&(i.status=s,i.invalidMessage=t)}),console.error("Failed to fetch sheets");return}e.setComponent("sheet-title",i=>{var a;e.util.isSelectComponent(i)&&(i.options=(a=t==null?void 0:t.sheets)==null?void 0:a.map(c=>({label:c.properties.title,value:c.properties.title})),i.loading=!1)})},C=e=>{let o=e+1,t="";for(;o>0;)o--,t=`${String.fromCharCode(o%26+65)}${t}`,o=Math.floor(o/26);return t},v=async e=>{var n,i,a;const o=await e.getConnection("expires_in");if(!o)return 0;const{data:t}=await m(o.auth_details.access_token,(n=e.getComponent("spreadsheet-id"))==null?void 0:n.value);return((a=(i=t==null?void 0:t.sheets)==null?void 0:i.find(c=>{var u;return c.properties.title===((u=e.getComponent("sheet-title"))==null?void 0:u.value)}))==null?void 0:a.properties.gridProperties.columnCount)||0},w=async e=>{var s,n,i,a,c,u;let o=[];const t=await e.getConnection("expires_in");if(!t)return o;if((s=e.getComponent("contains-header-row"))!=null&&s.value&&((n=e.getComponent("contains-header-row"))==null?void 0:n.value)==="yes"){const{data:l,status:p}=await f(t.auth_details.access_token,(i=e.getComponent("spreadsheet-id"))==null?void 0:i.value,(a=e.getComponent("sheet-title"))==null?void 0:a.value);if(p==="error"||l!=null&&l.error){e.setComponent("column-to-match-on",r=>{var d;e.util.isSelectComponent(r)&&(r.status="error",r.loading=!1,r.invalidMessage=(d=l.error)==null?void 0:d.message)}),console.error("Failed to fetch header rows");return}o=(u=(c=l==null?void 0:l.values)==null?void 0:c[0])==null?void 0:u.map((r,d)=>({label:r===""?C(d):r,value:`${d}:${r}`})).filter(r=>r.value)}else{const l=await v(e);for(let p=0;p<l;p++){const r=C(p);o.push({label:r,value:`${p}:${r}`})}}return o},A=async e=>{if(e.setComponent("column-to-match-on",s=>{s.loading=!0}),!await e.getConnection("expires_in")){e.setComponent("column-to-match-on",s=>{s.loading=!1});return}const t=await w(e);if(!t){e.setComponent("column-to-match-on",s=>{e.util.isSelectComponent(s)&&(s.loading=!1,s.options=[],s.value=void 0)});return}e.setComponent("column-to-match-on",s=>{e.util.isSelectComponent(s)&&(s.options=t,s.loading=!1)})},y=(e=26)=>{const o=[];for(let t=0;t<e;t+=1){let s=t,n="";t>25&&(n=String.fromCharCode(65+t%26),s=Math.floor(t/26)-1);const i=String.fromCharCode(65+s);o.push({label:i+n,value:i+n})}return o},x=async e=>{var s;e.setComponent("row-data",n=>{n.loading=!0,e.util.isRepeaterFieldComponent(n)&&(n.labelActionLoading=!0)});const o=await e.getConnection("expires_in");if(!o){e.setComponent("row-data",n=>{n.loading=!1,e.util.isRepeaterFieldComponent(n)&&(n.labelActionLoading=!1)});return}const{data:t}=await m(o.auth_details.access_token,(s=e.getComponent("spreadsheet-id"))==null?void 0:s.value);e.setComponent("row-data",n=>{var c,u;if(!e.util.isRepeaterFieldComponent(n))return;const i=n.fieldsMetaData[0],a=(u=(c=t==null?void 0:t.sheets)==null?void 0:c.find(l=>{var p;return l.properties.title===((p=e.getComponent("sheet-title"))==null?void 0:p.value)}))==null?void 0:u.properties.gridProperties.columnCount;i.options=y(a),n.loading=!1,n.labelActionLoading=!1})};export{R as a,A as b,b as f,S as h,x as s};
