import{a3 as C,a4 as h}from"./_applist-952.js";import{dx as _,aH as b,_ as o}from"./main-red-poems-invite.js";import{h as A,s as D}from"./machine.-578.js";import"./lodash-840.js";import"./mutative-12.js";globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(t,e){return this.cache.has(t)?this.cache.get(t):(this.cache.set(t,e),e)}};const N=async t=>_({headers:{Authorization:["Bearer ",{encryption:"hmac_decrypt",value:t}]},method:"POST",url:"https://login.mailchimp.com/oauth2/metadata"}),T=async(t,e)=>_({headers:{Authorization:["Bearer ",{encryption:"hmac_decrypt",value:t}]},method:"GET",url:`https://${e}.api.mailchimp.com/3.0/lists?count=1000&offset=0`}),f=async(t,e,a)=>_({headers:{Authorization:["Bearer ",{encryption:"hmac_decrypt",value:t}]},method:"GET",url:`https://${e}.api.mailchimp.com/3.0/lists/${a}/segments?count=1000&offset=0`}),v=async t=>b("mailchimp/get-audience-fields",t);globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(t,e){return this.cache.has(t)?this.cache.get(t):(this.cache.set(t,e),e)}};const E=async t=>{var d;t.setComponent("select-audience",l=>{l.loading=!0});const e=await t.getConnection();if(!e){t.setComponent("select-audience",l=>{l.loading=!1});return}const a=await N(e.auth_details.access_token);if(a.status=="error"||!((d=a.data)!=null&&d.dc)){t.setComponent("select-audience",l=>{l.loading=!1});return}t.setDb(l=>{l.dataCenter=a.data.dc});const{data:n,status:i}=await T(e.auth_details.access_token,a.data.dc);if(i=="error"){t.setComponent("select-audience",l=>{t.util.isSelectComponent(l)&&(l.status=i,l.invalidMessage=n)});return}t.setComponent("select-audience",l=>{var c;t.util.isSelectComponent(l)&&(l.options=(c=n==null?void 0:n.lists)==null?void 0:c.map(s=>({label:s.name,value:s.id})),l.loading=!1)})},p=async t=>{var d,l,c;t.setComponent("select-tag",s=>{s.loading=!0});const e=await t.getConnection();if(!e||!((d=t.db)!=null&&d.dataCenter)){t.setComponent("select-tag",s=>{s.loading=!1});return}const a=(l=t.getComponent("select-audience"))==null?void 0:l.value,{data:n,status:i}=await f(e.auth_details.access_token,(c=t.db)==null?void 0:c.dataCenter,a);if(i=="error"){t.setComponent("select-tag",s=>{t.util.isSelectComponent(s)&&(s.status=i,s.invalidMessage=n)});return}t.setComponent("select-tag",s=>{var m;t.util.isSelectComponent(s)&&(s.options=(m=n==null?void 0:n.segments)==null?void 0:m.map(u=>({label:u.name,value:u.name})),s.loading=!1)})},r=async t=>{var d,l,c,s;const e=await t.getConnection(),a=(d=t.getComponent("select-module"))==null?void 0:d.value,n=(l=t.getComponent("select-audience"))==null?void 0:l.value,{data:i}=await v({accessToken:e&&((c=e.auth_details)==null?void 0:c.access_token),dataCenter:(s=t.db)==null?void 0:s.dataCenter,listId:n,module:a});t.setComponent("field-map",m=>{if(!t.util.isRepeaterFieldComponent(m))return;const u=m.fieldsMetaData[0];u.options=i==null?void 0:i.audienceField,m.loading=!1}),A({$:t,componentId:"field-map",dbKey:"fieldMap",fields:i==null?void 0:i.audienceField,mapFieldKey:"mailchimpField",mapFieldValue:"value"})};globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(t,e){return this.cache.has(t)?this.cache.get(t):(this.cache.set(t,e),e)}};const L=C(({helpers:t})=>({states:{components:[{addConnectionHelpingText:o("You can find credentials from ")+`<a target="_blank" class="text-blue-600 underline" rel="noopener noreferrer nofollow" href="https://us7.admin.mailchimp.com/account/oauth2/">${o("Here")}</a>`,componentName:t.componentName.connection,connectionsTypes:[{authCodeEndpoint:{method:"GET",queryParams:{client_id:"",response_type:"code"},url:"https://login.mailchimp.com/oauth2/authorize"},encryptKeys:["access_token","refresh_token","client_secret"],label:o("OAuth 2"),refreshTokenUrl:"",tokenEndpoint:{bodyParams:{client_id:"",client_secret:"",grant_type:"authorization_code"},method:"POST",url:"https://login.mailchimp.com/oauth2/token"},type:"oauth2"}],fieldType:"config",id:"connection-id",label:o("Select Connection"),onConnectionAddChange:"CONNECTION_ADD_CHANGE",onConnectionChange:"SET_CONNECTION",render:!0,value:void 0},{componentName:t.componentName.select,defaultValue:"add_a_member_to_an_audience",id:"select-module",label:o("Select Module"),onChange:"HANDLE_SELECT_MODULE",options:[{label:o("Add a member to an audience"),value:"add_a_member_to_an_audience"},{label:o("Add tag to a member"),value:"add_tag_to_a_member"},{label:o("Remove tag from a member"),value:"remove_tag_from_a_member"}],path:"selectModule",render:"IF_CONNECTION_SELECTED",value:"add_a_member_to_an_audience"},{allowClear:!0,componentName:t.componentName.select,id:"select-audience",label:o("Select Audience"),onChange:"HANDLE_SELECT_AUDIENCE",onRefetch:"REFETCH_AUDIENCE",options:[],path:"selectAudience",render:"IF_CONNECTION_SELECTED",value:void 0},{componentName:t.componentName.select,id:"select-tag",label:o("Select Tag"),mode:"multiple",onChange:"HANDLE_SELECT_TAG",onRefetch:"REFETCH_TAG",options:[],path:"selectTags",render:"IF_AUDIENCE_SELECTED",showSearch:!0,value:void 0},{addItemButtonLabel:"Add Field",componentName:t.componentName.repeaterField,fieldsMetaData:[{componentName:t.componentName.select,label:o("Field"),name:"mailchimpField",options:[],showSearch:!0,style:{width:150},value:""},{componentName:t.componentName.mixInput,label:o("Value"),name:"value",value:[],wrapperClassName:"w-100"}],id:"field-map",label:o("Field Map"),labelActionIconName:"refresh-cw",labelActionOnClick:"REFETCH_AUDIENCE_FIELDS",labelActionText:o("Refetch Fields"),nonRemovableRows:[],onChange:"ON_CHANGE_FIELD_MAP_DATA",path:"fieldMap",render:"IF_AUDIENCE_SELECTED",value:[]},{componentName:t.componentName.select,defaultValue:"no",helperText:o("Add Address Field"),id:"add-address-field",label:o("Address Field"),onChange:"HANDLE_ADD_ADDRESS_FIELD",options:[{label:o("Yes"),value:"yes"},{label:o("No"),value:"no"}],path:"addAddressField",render:"IF_AUDIENCE_SELECTED",value:"no"},{addItemButtonLabel:"Add Field",componentName:t.componentName.repeaterField,fieldsMetaData:[{componentName:t.componentName.select,label:o("Field"),name:"mailchimpAddressField",options:[{label:o("Address 1"),value:"addr1"},{label:o("Address 2"),value:"addr2"},{label:o("City"),value:"city"},{label:o("Zip"),value:"zip"},{label:o("State"),value:"state"},{label:o("Country"),value:"country"}],showSearch:!0,style:{width:150},value:""},{componentName:t.componentName.mixInput,label:o("Value"),name:"value",value:[],wrapperClassName:"w-100"}],id:"address-field-map",label:o("Address Field Map"),nonRemovableRows:[0,1,2,3],onChange:"ON_CHANGE_ADDRESS_FIELD_MAP_DATA",path:"addressFieldMap",render:"IF_ADD_ADDRESS_SELECTED",value:[[{disabled:!0,name:"mailchimpAddressField",value:"addr1"},{name:"value",value:[]}],[{disabled:!0,name:"mailchimpAddressField",value:"city"},{name:"value",value:[]}],[{disabled:!0,name:"mailchimpAddressField",value:"zip"},{name:"value",value:[]}],[{disabled:!0,name:"mailchimpAddressField",value:"state"},{name:"value",value:[]}]]},{componentName:t.componentName.select,defaultValue:"no",helperText:o("Add Double Opt-in"),id:"double-opt-in",label:o("Double Opt-in"),onChange:"HANDLE_ADD_DOUBLE_OPT_IN",options:[{label:o("Yes"),value:"yes"},{label:o("No"),value:"no"}],path:"addDoubleOptIn",render:"IF_AUDIENCE_SELECTED",value:"no"},{componentName:t.componentName.select,defaultValue:"no",helperText:o("Update Responses if the Subscriber is exist?"),id:"update-subscriber",label:o("Update Subscriber"),onChange:"HANDLE_UPDATE_SUBSCRIBER",options:[{label:o("Yes"),value:"yes"},{label:o("No"),value:"no"}],path:"updateSubscriber",render:"IF_AUDIENCE_SELECTED",value:"no"}]},actions:{CONNECTION_ADD_CHANGE:({$:e,e:a})=>{e.setThisComponent(n=>{if(e.util.isConnectionComponent(n))for(const i of n.connectionsTypes)i.type==="oauth2"&&(i.authCodeEndpoint.queryParams&&(i.authCodeEndpoint.queryParams.client_id=a.clientId),i.tokenEndpoint.bodyParams&&(i.tokenEndpoint.bodyParams.client_id=a.clientId,i.tokenEndpoint.bodyParams.client_secret=a.clientSecret))})},IF_ADD_ADDRESS_SELECTED:({$:e})=>{var a;return((a=e.getComponent("add-address-field"))==null?void 0:a.value)==="yes"},IF_AUDIENCE_SELECTED:({$:e})=>{var a;return h((a=e.getComponent("select-audience"))==null?void 0:a.value)},IF_CONNECTION_SELECTED:({$:e})=>{var a;return h((a=e.getComponent("connection-id"))==null?void 0:a.value)},REFETCH_AUDIENCE:async({$:e})=>{await E(e)},REFETCH_AUDIENCE_FIELDS:async({$:e})=>{await r(e)},REFETCH_TAG:async({$:e})=>{await p(e)},HANDLE_SELECT_MODULE:({$:e,e:a})=>{e.setThisComponent(n=>{n.value=a}),e.setDb(n=>{n.selectModule=a}),r(e)},HANDLE_SELECT_AUDIENCE:({$:e,e:a})=>{e.setThisComponent(n=>{n.value=a}),e.setDb(n=>{n.selectAudience=a}),p(e),r(e)},HANDLE_SELECT_TAG:({$:e,e:a})=>{e.setThisComponent(n=>{n.value=a}),e.setDb(n=>{n.selectTags=a})},ON_CHANGE_FIELD_MAP_DATA:({$:e,e:a})=>{e.setThisComponent(n=>{n.value=a}),e.setDb(n=>{n.fieldMap=a})},HANDLE_ADD_ADDRESS_FIELD:({$:e,e:a})=>{e.setThisComponent(n=>{n.value=a}),e.setDb(n=>{n.addAddressField=a})},ON_CHANGE_ADDRESS_FIELD_MAP_DATA:({$:e,e:a})=>{e.setThisComponent(n=>{n.value=a}),e.setDb(n=>{n.addressFieldMap=a})},HANDLE_ADD_DOUBLE_OPT_IN:({$:e,e:a})=>{e.setThisComponent(n=>{n.value=a}),e.setDb(n=>{n.addDoubleOptIn=a})},HANDLE_UPDATE_SUBSCRIBER:({$:e,e:a})=>{e.setThisComponent(n=>{n.value=a}),e.setDb(n=>{n.updateSubscriber=a})},ON_MACHINE_LOAD:async({$:e})=>{D(e,[{db:"connectionId",id:"connection-id"},{db:"selectModule",id:"select-module"},{db:"selectAudience",id:"select-audience"},{db:"selectTags",id:"select-tag"},{db:"fieldMap",id:"field-map"},{db:"addAddressField",id:"add-address-field"},{db:"addressFieldMap",id:"address-field-map"},{db:"addDoubleOptIn",id:"double-opt-in"},{db:"updateSubscriber",id:"update-subscriber"}]),await Promise.all([E(e),p(e),r(e)])},SET_CONNECTION:async({$:e,e:a})=>{e.setThisComponent(n=>{n.value=a}),e.setDb(n=>{n.connectionId=a}),await Promise.all([E(e),p(e),r(e)])}}}));export{L as default};
